# OSRM Одесса

Репозиторий содержит Docker-конфигурацию сервиса OSRM с данными Одесской области. Контейнер сразу включает простую обёртку Flask, поэтому сервис можно запустить локально или развернуть на Railway без дополнительных настроек.

## Структура репозитория
```
osrm-odessa/
├── api/
│   ├── app.py
│   └── requirements.txt
├── routing/
│   ├── router.py
│   └── ...
├── data/
│   └── odessa_oblast.osm.pbf
├── Dockerfile
├── .stxxl
├── .gitignore
└── README.md
```

В каталоге `data` должен находиться файл `odessa_oblast.osm.pbf`, скачанный с [Geofabrik](https://download.geofabrik.de/). Файл `.stxxl` требуется для дискового кеширования и содержит:

```
disk=/tmp/stxxl,10G,syscall
```

Оба файла исключены из Git при помощи `.gitignore`.

## Использование
### Сборка и запуск локально
```
docker build -t osrm-odessa .
docker run -d -p 5000:5000 osrm-odessa
```
После запуска можно выполнить запрос:
```
curl "http://localhost:5000/route?start=30.7233,46.4825&end=30.7326,46.4775"
```

## API

- `/route?start=lon,lat&end=lon,lat` — расчёт маршрута.
- `/table?points=p1;p2[;...]` — матрица времени и расстояний.
- `/nearest?point=p&number=n` — ближайшие участки дороги.
- `/match?points=p1;p2[;...]` — привязка GPS-трека к карте.
- `/trip?points=p1;p2[;...]` — оптимальный объезд точек.

Все дополнительные параметры передаются напрямую в соответствующий сервис OSRM.

### Пример fetch
Запустите контейнер и откройте `http://localhost:5000/` в браузере. На странице приведён пример JavaScript, выполняющий `fetch` к API и выводящий ответ.

### Обновление данных
Для загрузки свежей карты и подготовки файлов OSRM выполните:
```
python scripts/update_data.py
```

### Выбор алгоритма
Переменная `OSRM_ALGORITHM` задаёт используемый движок (`ch` или `mld`).
Измените её, если требуется fallback на другой алгоритм.

### Развёртывание на Railway
1. Создайте новый проект Railway и подключите репозиторий.
2. Railway автоматически передаёт переменную `PORT`, дополнительных настроек не требуется.
3. Разверните проект и используйте выданный URL для запросов к сервису.
4. Включите автоматический рестарт сервиса при сбоях в настройках Railway.

### Заметки
- При необходимости замените `car.lua` на другой профиль (например, `foot.lua` или `bicycle.lua`).
- Обновляйте `odessa_oblast.osm.pbf` по мере выхода новых данных.
- Для корректной установки зависимостей в Dockerfile уже прописаны архивные репозитории Debian.
- Уровень логирования приложения фиксирован на `INFO`, а вывод перенаправлен в `stdout`, чтобы сообщение запуска не помечалось как `error` на Railway.

